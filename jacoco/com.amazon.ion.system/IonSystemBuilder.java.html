<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IonSystemBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.amazon.ion:ion-java</a> &gt; <a href="index.source.html" class="el_package">com.amazon.ion.system</a> &gt; <span class="el_source">IonSystemBuilder.java</span></div><h1>IonSystemBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007-2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed
 * on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

package com.amazon.ion.system;

import static com.amazon.ion.impl.lite._Private_LiteDomTrampoline.newLiteSystem;

import com.amazon.ion.IonCatalog;
import com.amazon.ion.IonReader;
import com.amazon.ion.IonSystem;
import com.amazon.ion.IonWriter;
import com.amazon.ion.SymbolTable;
import com.amazon.ion.impl._Private_IonBinaryWriterBuilder;
import com.amazon.ion.impl._Private_Utils;

/**
 * The builder for creating {@link IonSystem}s.
 * Most applications will only have one or two system instances;
 * see {@link IonSystem} for important constraints.
 * &lt;p&gt;
 * Builders may be configured once and reused to construct multiple
 * objects. They can be {@link #copy() copied} to create a mutable
 * copy of a prototype (presumably for altering some property).
 * &lt;p&gt;
 * &lt;b&gt;Instances of this class are not safe for use by multiple threads unless
 * they are {@linkplain #immutable() immutable}.&lt;/b&gt;
 * &lt;p&gt;
 * The easiest way to get going is to use the {@link #standard()} builder:
 *&lt;pre&gt;
 *    IonSystem ion = IonSystemBuilder.standard().build();
 *&lt;/pre&gt;
 * &lt;p&gt;
 * However, most long-lived applications will want to provide a custom
 * {@link IonCatalog} implementation rather than using the default
 * {@link SimpleCatalog}.  For example:
 *&lt;pre&gt;
 *    IonCatalog catalog = newCustomCatalog();
 *    IonSystemBuilder b = IonSystemBuilder.standard().copy();
 *    b.setCatalog(catalog);
 *    IonSystem ion = b.build();
 *&lt;/pre&gt;
 * &lt;p&gt;
 * Configuration properties follow the standard JavaBeans idiom in order to be
 * friendly to dependency injection systems.  They also provide alternative
 * mutation methods that enable a more fluid style:
 *&lt;pre&gt;
 *    IonCatalog catalog = newCustomCatalog();
 *    IonSystem ion = IonSystemBuilder.standard()
 *                                    .withCatalog(catalog)
 *                                    .build();
 *&lt;/pre&gt;
 *
 * &lt;h2&gt;Configuration Properties&lt;/h2&gt;
 * &lt;p&gt;
 * This builder provides the following configurable properties:
 * &lt;ul&gt;
 *   &lt;li&gt;
 *     &lt;b&gt;catalog&lt;/b&gt;: The {@link IonCatalog} used as a default when reading Ion
 *     data. If null, each system will be built with a new
 *     {@link SimpleCatalog}.
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &lt;b&gt;streamCopyOptimized&lt;/b&gt;: When true, this enables optimizations when
 *     copying data between two Ion streams. For example, in some cases raw
 *     binary-encoded Ion can be copied directly from the input to the output.
 *     This can have significant performance benefits when the appropriate
 *     conditions are met. &lt;b&gt;This feature is experimental! Please test
 *     thoroughly and report any issues.&lt;/b&gt;
 *   &lt;/li&gt;
 * &lt;/ul&gt;
 */
public class IonSystemBuilder
{
<span class="fc" id="L86">    private static final IonSystemBuilder STANDARD = new IonSystemBuilder();</span>

    /**
     * The standard builder of {@link IonSystem}s.
     * See the class documentation for the standard configuration.
     * &lt;p&gt;
     * The returned instance is immutable.
     */
    public static IonSystemBuilder standard()
    {
<span class="fc" id="L96">        return STANDARD;</span>
    }


    //=========================================================================

    IonCatalog myCatalog;
<span class="fc" id="L103">    boolean myStreamCopyOptimized = false;</span>
    IonReaderBuilder readerBuilder;


    /** You no touchy. */
    private IonSystemBuilder()
<span class="fc" id="L109">    {</span>
        // empty
<span class="fc" id="L111">    }</span>

    private IonSystemBuilder(IonSystemBuilder that)
<span class="fc" id="L114">    {</span>
<span class="fc" id="L115">        this.myCatalog      = that.myCatalog;</span>
<span class="fc" id="L116">        this.myStreamCopyOptimized = that.myStreamCopyOptimized;</span>
<span class="fc" id="L117">        this.readerBuilder = that.readerBuilder;</span>
<span class="fc" id="L118">    }</span>

    //=========================================================================

    /**
     * Creates a mutable copy of this builder.
     * @return a new builder with the same configuration as {@code this}.
     */
    public final IonSystemBuilder copy()
    {
<span class="fc" id="L128">        return new Mutable(this);</span>
    }

    /**
     * Returns an immutable builder configured exactly like this one.
     *
     * @return this instance, if immutable;
     * otherwise an immutable copy of this instance.
     *
     */
    public IonSystemBuilder immutable()
    {
<span class="fc" id="L140">        return this;</span>
    }

    /**
     * Returns a mutable builder configured exactly like this one.
     *
     * @return this instance, if mutable;
     * otherwise a mutable copy of this instance.
     *

     */
    public IonSystemBuilder mutable()
    {
<span class="fc" id="L153">        return copy();</span>
    }

    void mutationCheck()
    {
<span class="fc" id="L158">        throw new UnsupportedOperationException(&quot;This builder is immutable&quot;);</span>
    }


    //=========================================================================
    // Properties

    /**
     * Gets the catalog to use when building an {@link IonSystem}.
     * By default, this property is null.
     *
     * @see #setCatalog(IonCatalog)
     * @see #withCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     */
    public final IonCatalog getCatalog()
    {
<span class="fc" id="L175">        return myCatalog;</span>
    }

    /**
     * Sets the catalog to use when building an {@link IonSystem}.
     *
     * @param catalog the catalog to use in built systems.
     *  If null, each system will be built with a new {@link SimpleCatalog}.
     *
     * @see #getCatalog()
     * @see #withCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     *
     * @throws UnsupportedOperationException if this is immutable.
     */
    public final void setCatalog(IonCatalog catalog)
    {
<span class="fc" id="L192">        mutationCheck();</span>
<span class="fc" id="L193">        myCatalog = catalog;</span>
<span class="fc" id="L194">    }</span>

    /**
     * Declares the catalog to use when building an {@link IonSystem},
     * returning a new mutable builder if this is immutable.
     *
     * @param catalog the catalog to use in built systems.
     *  If null, each system will be built with a new {@link SimpleCatalog}.
     *
     * @see #getCatalog()
     * @see #setCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     */
    public final IonSystemBuilder withCatalog(IonCatalog catalog)
    {
<span class="fc" id="L209">        IonSystemBuilder b = mutable();</span>
<span class="fc" id="L210">        b.setCatalog(catalog);</span>
<span class="fc" id="L211">        return b;</span>
    }


    //=========================================================================


    /**
     * Indicates whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data.
     * By default, this property is false.
     *
     * @see #setStreamCopyOptimized(boolean)
     * @see #withStreamCopyOptimized(boolean)
     *

     */
    public final boolean isStreamCopyOptimized()
    {
<span class="fc" id="L230">        return myStreamCopyOptimized;</span>
    }

    /**
     * Declares whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data.
     * By default, this property is false.
     * &lt;p&gt;
     * &lt;b&gt;This feature is experimental! Please test thoroughly and report any
     * issues.&lt;/b&gt;
     *
     * @throws UnsupportedOperationException if this is immutable.
     *
     * @see #isStreamCopyOptimized()
     * @see #withStreamCopyOptimized(boolean)
     *

     */
    public final void setStreamCopyOptimized(boolean optimized)
    {
<span class="fc" id="L250">        mutationCheck();</span>
<span class="fc" id="L251">        myStreamCopyOptimized = optimized;</span>
<span class="fc" id="L252">    }</span>

    /**
     * Declares whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data,
     * returning a new mutable builder if this is immutable.
     * &lt;p&gt;
     * &lt;b&gt;This feature is experimental! Please test thoroughly and report any
     * issues.&lt;/b&gt;
     *
     * @see #isStreamCopyOptimized()
     * @see #setStreamCopyOptimized(boolean)
     *

     */
    public final IonSystemBuilder withStreamCopyOptimized(boolean optimized)
    {
<span class="fc" id="L269">        IonSystemBuilder b = mutable();</span>
<span class="fc" id="L270">        b.setStreamCopyOptimized(optimized);</span>
<span class="fc" id="L271">        return b;</span>
    }



    //=========================================================================

    /**
     * Gets the reader builder whose options will be used when building an
     * {@link IonSystem}. By default, {@link IonReaderBuilder#standard()} will
     * be used.
     *
     * @see #setReaderBuilder(IonReaderBuilder)
     * @see #withReaderBuilder(IonReaderBuilder)
     */
    public final IonReaderBuilder getReaderBuilder() {
<span class="nc" id="L287">        return readerBuilder;</span>
    }

    /**
     * Sets the reader builder whose options will be used to use when building
     * an {@link IonSystem}. The reader builder's catalog will never be used; the
     * catalog provided to {@link #setCatalog(IonCatalog)} or
     * {@link #withCatalog(IonCatalog)} will always be used instead.
     *
     * @param builder the reader builder to use in built systems.
     *  If null, each system will be built with {@link IonReaderBuilder#standard()}.
     *
     * @see #getReaderBuilder()
     * @see #withReaderBuilder(IonReaderBuilder)
     *
     * @throws UnsupportedOperationException if this is immutable.
     */
    public final void setReaderBuilder(IonReaderBuilder builder) {
<span class="fc" id="L305">        mutationCheck();</span>
<span class="fc" id="L306">        readerBuilder = builder;</span>
<span class="fc" id="L307">    }</span>

    /**
     * Declares the reader builder whose options will be used to use when building
     * an {@link IonSystem}, returning a new mutable builder if this is immutable.
     * The reader builder's catalog will never be used; the catalog provided to
     * {@link #setCatalog(IonCatalog)} or {@link #withCatalog(IonCatalog)} will
     * always be used instead.
     *
     * @param builder the reader builder to use in built systems.
     *  If null, each system will be built with {@link IonReaderBuilder#standard()}.
     *
     * @see #getReaderBuilder()
     * @see #setReaderBuilder(IonReaderBuilder)
     */
    public final IonSystemBuilder withReaderBuilder(IonReaderBuilder builder)
    {
<span class="fc" id="L324">        IonSystemBuilder b = mutable();</span>
<span class="fc" id="L325">        b.setReaderBuilder(builder);</span>
<span class="fc" id="L326">        return b;</span>
    }

    //=========================================================================

    /**
     * Builds a new {@link IonSystem} instance based on this builder's
     * configuration properties.
     */
    public final IonSystem build()
    {
        IonCatalog catalog =
<span class="fc bfc" id="L338" title="All 2 branches covered.">            (myCatalog != null ? myCatalog : new SimpleCatalog());</span>

        IonTextWriterBuilder twb =
<span class="fc" id="L341">            IonTextWriterBuilder.standard().withCharsetAscii();</span>
<span class="fc" id="L342">        twb.setCatalog(catalog);</span>

        _Private_IonBinaryWriterBuilder bwb =
<span class="fc" id="L345">            _Private_IonBinaryWriterBuilder.standard();</span>
<span class="fc" id="L346">        bwb.setCatalog(catalog);</span>
<span class="fc" id="L347">        bwb.setStreamCopyOptimized(myStreamCopyOptimized);</span>

        // TODO Would be nice to remove this since it's implied by the BWB.
        //      However that currently causes problems in the IonSystem
        //      constructors (which get a null initialSymtab).
<span class="fc" id="L352">        SymbolTable systemSymtab = _Private_Utils.systemSymtab(1);</span>
<span class="fc" id="L353">        bwb.setInitialSymbolTable(systemSymtab);</span>
        // This is what we need, more or less.
//        bwb = bwb.fillDefaults();
<span class="fc bfc" id="L356" title="All 2 branches covered.">        IonReaderBuilder rb = readerBuilder == null ? IonReaderBuilder.standard() : readerBuilder;</span>
<span class="fc" id="L357">        rb = rb.withCatalog(catalog);</span>
<span class="fc" id="L358">        return newLiteSystem(twb, bwb, rb);</span>
    }

    //=========================================================================

    private static final class Mutable
        extends IonSystemBuilder
    {
        private Mutable(IonSystemBuilder that)
        {
<span class="fc" id="L368">            super(that);</span>
<span class="fc" id="L369">        }</span>

        @Override
        public IonSystemBuilder immutable()
        {
<span class="fc" id="L374">            return new IonSystemBuilder(this);</span>
        }

        @Override
        public IonSystemBuilder mutable()
        {
<span class="fc" id="L380">            return this;</span>
        }

        @Override
        void mutationCheck()
        {
<span class="fc" id="L386">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>